table(data_5BT65$keycontacts_call_totaldegree) # merge level 2 to level 1 -> turn into a binary variable
table(data_5BT65$keycontacts_text_reciprocity_degree) # merge level 2&3 to level 1 -> turn into a binary variable
keycontacts_call_totaldegree_binary=data_5BT65$keycontacts_call_totaldegree;keycontacts_call_totaldegree_binary[keycontacts_call_totaldegree_binary==2]=1;table(keycontacts_call_totaldegree_binary)
keycontacts_text_reciprocity_degree_binary=data_5BT65$keycontacts_text_reciprocity_degree;keycontacts_text_reciprocity_degree_binary[keycontacts_text_reciprocity_degree_binary>1]=1;table(keycontacts_text_reciprocity_degree_binary)
data=data.frame(Date=data_5BT65$Date,negative_total=data_5BT65$negative_total,
keycontacts_call_totaldegree_binary,
keycontacts_text_reciprocity_degree_binary,
logit_TAM_phone=log(TAM_phone_modified/(1-TAM_phone_modified)))
param=list(list(lagged_param=list(variables=colnames(data)[-1],param=rep(3,length(colnames(data)[-1])))))
data=add_variables_procedures(data,param);
data=data.frame(intercept=1,data);colnames(data)
######################## Part I:  initial guess of ssm structure ########################
n_variables=5
ssm_c_init=SSModel(logit_TAM_phone ~ -1 + SSMregression(~ intercept + logit_TAM_phone_1+
keycontacts_call_totaldegree_binary+
keycontacts_text_reciprocity_degree_binary+
negative_total,
data=data,Q=diag(rep(NA,n_variables))),
data,H=NA) # baseline variance constant
ssm_c_init_fit=fitSSM(ssm_c_init, inits =rep(0,n_variables+1), method = "BFGS") # n_variables + one NA in H
ssm_c_init_out=KFS(ssm_c_init_fit$model)
plot.KFS(ssm_c_init_out,range=30:708)
ssm_c_init_out$model$H;ssm_c_init_out$model$Q
######################## Part II: statespace model without imputation ########################
formula="logit_TAM_phone ~ intercept + logit_TAM_phone_1 + keycontacts_call_totaldegree_binary + keycontacts_text_reciprocity_degree_binary + negative_total"
all_var=unlist(strsplit(gsub(" ","",formula),"\\+|\\~"))
outcome_var=strsplit(gsub(" ","",formula),"\\~")[[1]][1]
formula_var=all_var[!(all_var %in% c(outcome_var,"intercept"))]
data_ss_ignore=data[,all_var]
colnames(data_ss_ignore)=gsub(outcome_var,"y",colnames(data_ss_ignore))
formula_var=gsub(outcome_var,"y",formula_var)
data_ss_ignore=data_ss_ignore[-1,]
data_ss_ignore$y[rowSums(is.na(data_ss_ignore))!=0]=NA
for(l in formula_var){
data_ss_ignore[is.na(data_ss_ignore[,l]),l]=mean(data_ss_ignore[,l],na.rm=T)
}
head(data_ss_ignore);dim(data_ss_ignore)
ss_param_keycontacts=list(inits=c(log(0.05),log(5)),m0=ssm_c_init_out$att[708,],C0=diag(rep(10^3),5),
AR1_coeffi=NULL,rw_coeffi=c("intercept"),v_cp_param=NULL,
w_cp_param=list(list(variable="y_1",segments=3,changepoints=c(410,450),fixed_cpts=F),
list(variable="keycontacts_text_reciprocity_degree_binary",segments=2,changepoints=c(415),fixed_cpts=F)))
ssm_c=run.SSM_partial_converged_cpts(data_ss=data_ss_ignore,formula_var=formula_var,ss_param=ss_param_keycontacts,max_iteration=100,
cpt_learning_param=list(cpt_method="mean",burnin=1/10,mergeband=10,convergence_cri=5),
dlm_cpt_learning_option="filter",
dlm_option="smooth",printFlag=T,bandwidth=5,cpt_V =1)
ssm_c_smooth=dlmSmooth(ssm_c$out_filter)
ssm_c$estimated_cpts
######################## Part I: initial guess of ssm structure ########################
n_variables=7
ssm_y_init=SSModel(negative_total ~ -1 + SSMregression(~ intercept + negative_total_1+
keycontacts_call_totaldegree_binary+keycontacts_call_totaldegree_binary_1+
keycontacts_text_reciprocity_degree_binary+keycontacts_text_reciprocity_degree_binary_1+
logit_TAM_phone_1,
data=data,Q=diag(rep(NA,n_variables))),
data,H=NA) # baseline variance constant
ssm_y_init_fit=fitSSM(ssm_y_init, inits =rep(0,n_variables+1), method = "BFGS") # n_variables + one NA in H
ssm_y_init_out=KFS(ssm_y_init_fit$model)
plot.KFS(ssm_y_init_out,range=30:708)
ssm_y_init_out$model$Q; ssm_y_init_out$model$H
######################## Part II: statespace model without imputation ########################
formula=" negative_total ~ intercept + negative_total_1 + keycontacts_call_totaldegree_binary + keycontacts_call_totaldegree_binary_1 + keycontacts_text_reciprocity_degree_binary + keycontacts_text_reciprocity_degree_binary_1+ logit_TAM_phone_1"
all_var=unlist(strsplit(gsub(" ","",formula),"\\+|\\~"))
outcome_var=strsplit(gsub(" ","",formula),"\\~")[[1]][1]
formula_var=all_var[!(all_var %in% c(outcome_var,"intercept"))]
data_ss_ignore_y=data[,all_var]
colnames(data_ss_ignore_y)=gsub(outcome_var,"y",colnames(data_ss_ignore_y))
formula_var=gsub(outcome_var,"y",formula_var)
data_ss_ignore_y=data_ss_ignore_y[-1,]
data_ss_ignore_y$y[rowSums(is.na(data_ss_ignore_y))!=0]=NA
for(l in formula_var){
data_ss_ignore_y[is.na(data_ss_ignore_y[,l]),l]=mean(data_ss_ignore_y[,l],na.rm=T)
}
ss_param_temp=list(inits=c(log(0.2),log(2.5)),m0=ssm_y_init$att[708,],C0=diag(rep(10^3),7),
AR1_coeffi=NULL,rw_coeffi=c("intercept"),v_cp_param=NULL,
w_cp_param=list(list(variable="keycontacts_text_reciprocity_degree_binary",segments=3,changepoints=c(560,640),fixed_cpts=F),
list(variable="keycontacts_text_reciprocity_degree_binary_1",segments=2,changepoints=c(460),fixed_cpts=F)))
ssm_y=run.SSM_partial_converged_cpts(data_ss=data_ss_ignore_y,formula_var=formula_var,ss_param=ss_param_temp,max_iteration=100,
cpt_learning_param=list(cpt_method="mean",burnin=1/10,mergeband=20,convergence_cri=10),
dlm_cpt_learning_option="filter",
dlm_option="smooth",printFlag=T,bandwidth = 5, cpt_V = 1)
ssm_y$estimated_cpts
ssm_y_smooth=dlmSmooth(ssm_y$out_filter)
############################################################################
######     simulate/compute causal estimands of calls with CI          #####
############################################################################
# jump directly to load the data without recalculation!!
y_coeffi_var_table=lapply(1:nrow(ssm_y$out_smooth$s),function(i){dlmSvd2var(ssm_y$out_smooth$U.S[[i]],ssm_y$out_smooth$D.S[i,])});head(y_coeffi_var_table)
c_coeffi_var_table=lapply(1:nrow(ssm_c$out_smooth$s),function(i){dlmSvd2var(ssm_c$out_smooth$U.S[[i]],ssm_c$out_smooth$D.S[i,])});head(c_coeffi_var_table)
raw_data=data[,c(2,3,4,6)];colnames(raw_data)=c("Date","y","x","c");head(raw_data)
#########################################################################
######          simulate causal estimands of texts with CI          #####
#########################################################################
# jump directly to load the data without recalculation!!
# covariates has been extracted before in the calculation of calls
# y_coeffi_var_table=lapply(1:nrow(ssm_y$out_smooth$s),function(i){dlmSvd2var(ssm_y$out_smooth$U.S[[i]],ssm_y$out_smooth$D.S[i,])});head(y_coeffi_var_table)
# c_coeffi_var_table=lapply(1:nrow(ssm_c$out_smooth$s),function(i){dlmSvd2var(ssm_c$out_smooth$U.S[[i]],ssm_c$out_smooth$D.S[i,])});head(c_coeffi_var_table)
# second, calculate for texts
y_coeffi_table=as.data.frame(ssm_y$out_smooth$s);colnames(y_coeffi_table)[c(1:2,5:7)]=c("(Intercept)","y_1","x","x_1","c");head(y_coeffi_table)
c_coeffi_table=as.data.frame(ssm_c$out_smooth$s);colnames(c_coeffi_table)[c(1,2,4,5)]=c("(Intercept)","c_1","x_1","y_1");head(c_coeffi_table)
raw_data=data[,c(2,3,5,7)];colnames(raw_data)=c("Date","y","x","c");head(raw_data)
# calculate text's 4-step general effect directly with CI
set.seed(6)
text_3_step_general_0101 = calculate.effect_allt_withCI(tx=c(0,1,0,1),y_coeffi_table=y_coeffi_table,y_coeffi_var_table=y_coeffi_var_table,c_coeffi_table=c_coeffi_table,c_coeffi_var_table=c_coeffi_var_table,n_sim=1000,printFlag=T)
save(text_contemporaneous,
text_1_lag,text_1_lag_structural_direct,
text_1_step,text_2_step_general_101,
text_3_step_general_0101,
text_effects_vs_qlag,
text_effects_vs_qstep,
file="/Users/xiaoxuancai/Dropbox (Personal)/MHealthPsychSummerProject2020/Xiaoxuan_Cai/[Paper 1] Causal estimands and Graphical representation for time series data/result_texts.Rdata")
load("/Users/xiaoxuancai/Dropbox (Personal)/MHealthPsychSummerProject2020/Xiaoxuan_Cai/[Paper 1] Causal estimands and Graphical representation for time series data/result_texts.Rdata")
save(text_contemporaneous,
text_1_lag,text_1_lag_structural_direct,
text_1_step,text_2_step_general_101,
text_3_step_general_0101,
text_effects_vs_qlag,
text_effects_vs_qstep,
file="/Users/xiaoxuancai/Dropbox (Personal)/MHealthPsychSummerProject2020/Xiaoxuan_Cai/[Paper 1] Causal estimands and Graphical representation for time series data/result_texts.Rdata")
text_3_step_general_0101_CIband = plot_simulatedCI(t(text_3_step_general_0101),probs=c(0.05,0.95),printFlag=F)
plot(1:708,text_3_step_general_0101_CIband$mean,type="l",ylab="3-step general effect (texts)",xlab="# lags",bty="n",cex.axis=1.5,cex.lab=1.5,ylim=c(-4,0.5))
polygon(c(1:708,rev(1:708)),c(text_3_step_general_0101_CIband$upper,rev(text_3_step_general_0101_CIband$lower)),col="grey90",border="grey")
points(1:708,text_3_step_general_0101_CIband$mean,type="l")
text_3_step_general_0101_CIband = plot_simulatedCI(t(text_3_step_general_0101),probs=c(0.05,0.95),printFlag=F)
plot(1:708,text_3_step_general_0101_CIband$mean,type="l",ylab="4-step general effect (texts)",xlab="# lags",bty="n",cex.axis=2.5,cex.lab=2.5,ylim=c(-4,0.5))
par(mar = c(2.5, 5, .5, .5))
par(mfrow=c(1,1))
text_3_step_general_0101_CIband = plot_simulatedCI(t(text_3_step_general_0101),probs=c(0.05,0.95),printFlag=F)
plot(1:708,text_3_step_general_0101_CIband$mean,type="l",ylab="4-step general effect (texts)",xlab="# lags",bty="n",cex.axis=2.5,cex.lab=2.5,ylim=c(-4,0.5))
par(mar = c(2, 5, .1, .1))
par(mfrow=c(1,1))
text_3_step_general_0101_CIband = plot_simulatedCI(t(text_3_step_general_0101),probs=c(0.05,0.95),printFlag=F)
par(mar = c(4, 5, .1, .1))
par(mfrow=c(1,1))
text_3_step_general_0101_CIband = plot_simulatedCI(t(text_3_step_general_0101),probs=c(0.05,0.95),printFlag=F)
plot(1:708,text_3_step_general_0101_CIband$mean,type="l",ylab="4-step general effect (texts)",xlab="# lags",bty="n",cex.axis=2.5,cex.lab=2.5,ylim=c(-4,0.5))
plot(1:708,text_3_step_general_0101_CIband$mean,type="l",ylab="4-step general effect (texts)",xlab="days",bty="n",cex.axis=2.5,cex.lab=2.5,ylim=c(-4,0.5))
par(mar = c(5, 5, .1, .1))
plot(1:708,text_3_step_general_0101_CIband$mean,type="l",ylab="4-step general effect (texts)",xlab="days",bty="n",cex.axis=2.5,cex.lab=2.5,ylim=c(-4,0.5))
polygon(c(1:708,rev(1:708)),c(text_3_step_general_0101_CIband$upper,rev(text_3_step_general_0101_CIband$lower)),col="grey90",border="grey")
points(1:708,text_3_step_general_0101_CIband$mean,type="l")
abline(h=0,lty=3,lwd=2)
text(10,0.5, "a)",cex=2.5)
legend("bottomright",legend=c("estimate", "95% CI"),
pch = c(NA,15), lty=c(1,NA), col=c("black","grey"),
bty = "n", # remove the bounder of the legend
lwd = c(1,NA), pt.bg = c(NA,"grey90"),cex=2)
# text's 3-step general effect
pdf(file = paste(location,"step3_general_0101_texts.pdf",sep=""),
width = 10, # The width of the plot in inches
height = 6) # The height of the plot in inches
par(mar = c(5, 5, .1, .1))
par(mfrow=c(1,1))
text_3_step_general_0101_CIband = plot_simulatedCI(t(text_3_step_general_0101),probs=c(0.05,0.95),printFlag=F)
plot(1:708,text_3_step_general_0101_CIband$mean,type="l",ylab="4-step general effect (texts)",xlab="days",bty="n",cex.axis=2.5,cex.lab=2.5,ylim=c(-4,0.5))
# text's contemporaneous effect
# Chosen in maintext of the paper (Figure 4a)
location="/Users/xiaoxuancai/Dropbox (Personal)/MHealthPsychSummerProject2020/Xiaoxuan_Cai/[Paper 1] Causal estimands and Graphical representation for time series data/"
# text's 3-step general effect (Figure 6a)
pdf(file = paste(location,"step3_general_0101_texts.pdf",sep=""),
width = 10, # The width of the plot in inches
height = 6) # The height of the plot in inches
par(mar = c(5, 5, .1, .1))
par(mfrow=c(1,1))
text_3_step_general_0101_CIband = plot_simulatedCI(t(text_3_step_general_0101),probs=c(0.05,0.95),printFlag=F)
plot(1:708,text_3_step_general_0101_CIband$mean,type="l",ylab="4-step general effect (texts)",xlab="days",bty="n",cex.axis=2.5,cex.lab=2.5,ylim=c(-4,0.5))
polygon(c(1:708,rev(1:708)),c(text_3_step_general_0101_CIband$upper,rev(text_3_step_general_0101_CIband$lower)),col="grey90",border="grey")
points(1:708,text_3_step_general_0101_CIband$mean,type="l")
abline(h=0,lty=3,lwd=2)
text(10,0.5, "a)",cex=2.5)
legend("bottomright",legend=c("estimate", "95% CI"),
pch = c(NA,15), lty=c(1,NA), col=c("black","grey"),
bty = "n", # remove the bounder of the legend
lwd = c(1,NA), pt.bg = c(NA,"grey90"),cex=2.5)
dev.off()
########################################################################
######         personalized intervention effect (text)             #####
########################################################################
t=600;n_sim=1000
set.seed(1)
qstep1001001=simulate.counterfactual_singlet_withCI(t,tx=c(1,0,0,1,0,0,1,rep(0,10)),y_coeffi_table,y_coeffi_var_table,c_coeffi_table,c_coeffi_var_table,raw_data,n_sim=n_sim,printFlag=T)
########################################################################
######         personalized intervention effect (text)             #####
########################################################################
t=600;n_sim=1000
set.seed(1)
qstep1001001=simulate.counterfactual_singlet(t,tx=c(1,0,0,1,0,0,1,rep(0,10)),y_coeffi_table,c_coeffi_table,raw_data,n_sim=n_sim,printFlag=T)
########################################################################
######         personalized intervention effect (text)             #####
########################################################################
t=600;n_sim=1000
########################################################################
######         personalized intervention effect (text)             #####
########################################################################
t=600;n_sim=1000
set.seed(1)
qstep1001001=simulate.counterfactual_singlet(t,tx=c(1,0,0,1,0,0,1,rep(0,10)),y_coeffi_table,c_coeffi_table,raw_data,printFlag=T)
set.seed(1)
qstep0101010=simulate.counterfactual_singlet(t,tx=c(0,1,0,1,0,1,0,rep(0,10)),y_coeffi_table,c_coeffi_table,raw_data,printFlag=T)
set.seed(1)
qstep1110000=simulate.counterfactual_singlet(t,tx=c(1,1,1,0,0,0,0,rep(0,10)),y_coeffi_table,c_coeffi_table,raw_data,printFlag=T)
set.seed(1)
qstep0000000=simulate.counterfactual_singlet(t,tx=c(0,0,0,0,0,0,0,rep(0,10)),y_coeffi_table,c_coeffi_table,raw_data,printFlag=T)
plot(0:16,qstep1110000,type="l",ylab="Effect of 1-week intervention (texts)",xlab="# days",bty="n",cex.axis=2,cex.lab=2,ylim=c(-4,0.5))
plot(0:16,qstep1110000-qstep0000000,type="l",ylab="Effect of 1-week intervention (texts)",xlab="# days",bty="n",cex.axis=2,cex.lab=2,ylim=c(-4,0.5))
polygon(x = c(-0.1,6,6,-0.1),
y = c(-4,-4,0.5,0.5),
col = "lightcyan",border ="NA")
polygon(x = c(-0.1,6,6,-0.1),
y = c(-4,-4,0.5,0.5),
col = "lightgrey",border ="NA")
points(0:16,qstep1110000-qstep0000000,type="l")
text(2.9,0.2,"1-week of intervention",cex=1.7)
points(0:16,qstep1110000-qstep0000000,pch=15)
plot(0:16,qstep1110000-qstep0000000,type="l",ylab="Effect of 1-week intervention (texts)",xlab="# days",bty="n",cex.axis=2.5,cex.lab=2.5,ylim=c(-4,0.5))
plot(0:16,qstep1110000-qstep0000000,type="l",ylab="General effect of 7-day interventions (texts)",xlab="days",bty="n",cex.axis=2.5,cex.lab=2.5,ylim=c(-4,0.5))
polygon(x = c(-0.1,6,6,-0.1),
y = c(-4,-4,0.5,0.5),
col = "lightgrey",border ="NA")
points(0:16,qstep1110000-qstep0000000,type="l")
text(2.9,0.2,"1-week of intervention",cex=1.7)
points(0:16,qstep1110000-qstep0000000,pch=15)
points(0:16,qstep1110000-qstep0000000,pch=15.cex=2)
points(0:16,qstep1110000-qstep0000000,pch=15,cex=2)
legend("bottomright",legend=c("tx=(1,1,1,0,0,0,0)","",""),
pch = c(15,16,17), lty=c(1,2,4), col=c("black","white","white"),
bty = "n", # remove the bounder of the legend
lwd = c(1,NA), pt.bg = c(NA,"grey90"),cex=2.5)
points(0:16,qstep0101010-qstep0000000,type="l",pch=17,lty=2, col="brown")
points(0:16,qstep0101010-qstep0000000,pch=16,lty=3, col="brown")
points(0:16,qstep0101010-qstep0000000,type="l",pch=17,lty=2, col="brown",cex=2.5)
points(0:16,qstep0101010-qstep0000000,pch=16,lty=3, col="brown",cex=2.5)
legend("bottomright",legend=c("tx=(1,1,1,0,0,0,0)","tx=(0,1,0,1,0,1,0)",""),
pch = c(15,16,17), lty=c(1,2,4), col=c("black","brown","white"),
bty = "n", # remove the bounder of the legend
lwd = c(1,NA), pt.bg = c(NA,"grey90"),cex=2.5)
legend("bottomright",legend=c("tx=(1,1,1,0,0,0,0)","tx=(0,1,0,1,0,1,0)",""),
pch = c(15,16,17), lty=c(1,2,4), col=c("black","brown","white"),
bty = "n", # remove the bounder of the legend
lwd = c(1,1), pt.bg = c(NA,"grey90"),cex=2.5)
points(0:16,qstep1001001-qstep0000000,type="l",pch=15,lty=4,col="blue",cex=2.5)
points(0:16,qstep1001001-qstep0000000,pch=17,lty=2,col="blue",cex=2.5)
abline(v=6,lty=2,lwd=2,col="red")
text(0,.5,"b)",cex=2.5)
legend("bottomright",legend=c("tx=(1,1,1,0,0,0,0)","tx=(0,1,0,1,0,1,0)",""),
pch = c(15,16,17), lty=c(1,2,4), col=c("black","brown","white"),
bty = "n", # remove the bounder of the legend
lwd = c(1,1,1), pt.bg = c(NA,"grey90"),cex=2.5)
legend("bottomright",legend=c("tx=(1,1,1,0,0,0,0)","tx=(0,1,0,1,0,1,0)","tx=(1,0,0,1,0,0,1)"),
pch = c(15,16,17), lty=c(1,2,4), col=c("black","brown","blue"),
bty = "n", # remove the bounder of the legend
lwd = c(1,1,1), pt.bg = c(NA,"grey90"),cex=2.5)
par(mar = c(5, 5, .1, .1))
par(mfrow=c(1,1))
plot(0:16,qstep1110000-qstep0000000,type="l",ylab="General effect of 7-day interventions (texts)",xlab="days",bty="n",cex.axis=2.5,cex.lab=2.5,ylim=c(-4,0.5))
plot(0:16,qstep1110000-qstep0000000,type="l",ylab="General effect of 7-day interventions (texts)",xlab="days",bty="n",cex.axis=2.5,cex.lab=2,ylim=c(-4,0.5))
plot(0:16,qstep1110000-qstep0000000,type="l",ylab="General effect of 7-day (texts)",xlab="days",bty="n",cex.axis=2.5,cex.lab=2,ylim=c(-4,0.5))
plot(0:16,qstep1110000-qstep0000000,type="l",ylab="General effect of 7-day (texts)",xlab="days",bty="n",cex.axis=2.5,cex.lab=2.5,ylim=c(-4,0.5))
polygon(x = c(-0.1,6,6,-0.1),
y = c(-4,-4,0.5,0.5),
col = "lightgrey",border ="NA")
plot(0:16,qstep1110000-qstep0000000,type="l",ylab="General effects of 7-day strategy (texts)",xlab="days",bty="n",cex.axis=2.5,cex.lab=2.5,ylim=c(-4,0.5))
plot(0:16,qstep1110000-qstep0000000,type="l",ylab="General effects of 7-day strategy (texts)",xlab="days",bty="n",cex.axis=2.5,cex.lab=2.5,ylim=c(-4,1))
plot(0:16,qstep1110000-qstep0000000,type="l",ylab="General effects of 7-day strategy (texts)",xlab="days",bty="n",cex.axis=2.5,cex.lab=2.5,ylim=c(-4,0.5))
par(mar = c(5, 5, 1, .1))
par(mfrow=c(1,1))
plot(0:16,qstep1110000-qstep0000000,type="l",ylab="General effects of 7-day strategy (texts)",xlab="days",bty="n",cex.axis=2.5,cex.lab=2.5,ylim=c(-4,0.5))
par(mar = c(5, 5, 1.5, .1))
par(mfrow=c(1,1))
plot(0:16,qstep1110000-qstep0000000,type="l",ylab="General effects of 7-day strategy (texts)",xlab="days",bty="n",cex.axis=2.5,cex.lab=2.5,ylim=c(-4,0.5))
polygon(x = c(-0.1,6,6,-0.1),
y = c(-4,-4,0.5,0.5),
col = "lightgrey",border ="NA")
points(0:16,qstep1110000-qstep0000000,type="l")
text(2.9,0.2,"1-week of intervention",cex=1.7)
points(0:16,qstep1110000-qstep0000000,pch=15,cex=2)
points(0:16,qstep0101010-qstep0000000,type="l",pch=17,lty=2, col="brown",cex=2.5)
text(2.9,0.2,"1-week of intervention",cex=2)
plot(0:16,qstep1110000-qstep0000000,type="l",ylab="General effects of 7-day strategy (texts)",xlab="days",bty="n",cex.axis=2.5,cex.lab=2.5,ylim=c(-4,0.5))
polygon(x = c(-0.1,6,6,-0.1),
y = c(-4,-4,0.5,0.5),
col = "lightgrey",border ="NA")
points(0:16,qstep1110000-qstep0000000,type="l")
text(2.9,0.2,"1-week of intervention",cex=2)
points(0:16,qstep1110000-qstep0000000,pch=15,cex=2)
points(0:16,qstep0101010-qstep0000000,type="l",pch=17,lty=2, col="brown",cex=2.5)
points(0:16,qstep0101010-qstep0000000,pch=16,lty=3, col="brown",cex=2.5)
points(0:16,qstep1001001-qstep0000000,type="l",pch=15,lty=4,col="blue",cex=2.5)
points(0:16,qstep1001001-qstep0000000,pch=17,lty=2,col="blue",cex=2.5)
plot(0:16,qstep1110000-qstep0000000,type="l",ylab="General effects of 7-day strategy (texts)",xlab="days",bty="n",cex.axis=2.5,cex.lab=2.5,ylim=c(-4,0.5))
polygon(x = c(-0.1,6,6,-0.1),
y = c(-4,-4,0.5,0.5),
col = "lightgrey",border ="NA")
points(0:16,qstep1110000-qstep0000000,type="l")
text(2.9,0.2,"1-week of intervention",cex=2)
points(0:16,qstep1110000-qstep0000000,pch=15,cex=2)
points(0:16,qstep0101010-qstep0000000,type="l",pch=17,lty=2, col="brown",cex=2)
points(0:16,qstep0101010-qstep0000000,pch=16,lty=3, col="brown",cex=2)
points(0:16,qstep1001001-qstep0000000,type="l",pch=15,lty=4,col="blue",cex=2)
points(0:16,qstep1001001-qstep0000000,pch=17,lty=2,col="blue",cex=2)
abline(v=6,lty=2,lwd=2,col="red")
text(0,.5,"b)",cex=2.5)
legend("bottomright",legend=c("tx=(1,1,1,0,0,0,0)","tx=(0,1,0,1,0,1,0)","tx=(1,0,0,1,0,0,1)"),
pch = c(15,16,17), lty=c(1,2,4), col=c("black","brown","blue"),
bty = "n", # remove the bounder of the legend
lwd = c(1,1,1), pt.bg = c(NA,"grey90"),cex=2.5)
dev.off()
d
d
d
pdf(file = paste(location,"optimal_tx.pdf",sep=""),
width = 10, # The width of the plot in inches
height = 6) # The height of the plot in inches
par(mar = c(5, 5, 1.5, .1))
par(mfrow=c(1,1))
plot(0:16,qstep1110000-qstep0000000,type="l",ylab="General effects of 7-day strategy (texts)",xlab="days",bty="n",cex.axis=2.5,cex.lab=2.5,ylim=c(-4,0.5))
polygon(x = c(-0.1,6,6,-0.1),
y = c(-4,-4,0.5,0.5),
col = "lightgrey",border ="NA")
points(0:16,qstep1110000-qstep0000000,type="l")
text(2.9,0.2,"1-week of intervention",cex=2)
points(0:16,qstep1110000-qstep0000000,pch=15,cex=2)
points(0:16,qstep0101010-qstep0000000,type="l",pch=17,lty=2, col="brown",cex=2)
points(0:16,qstep0101010-qstep0000000,pch=16,lty=3, col="brown",cex=2)
points(0:16,qstep1001001-qstep0000000,type="l",pch=15,lty=4,col="blue",cex=2)
points(0:16,qstep1001001-qstep0000000,pch=17,lty=2,col="blue",cex=2)
abline(v=6,lty=2,lwd=2,col="red")
text(0,.5,"b)",cex=2.5)
legend("bottomright",legend=c("tx=(1,1,1,0,0,0,0)","tx=(0,1,0,1,0,1,0)","tx=(1,0,0,1,0,0,1)"),
pch = c(15,16,17), lty=c(1,2,4), col=c("black","brown","blue"),
bty = "n", # remove the bounder of the legend
lwd = c(1,1,1), pt.bg = c(NA,"grey90"),cex=2.5)
dev.off()
pdf(file = paste(location,"optimal_tx.pdf",sep=""),
width = 10, # The width of the plot in inches
height = 6) # The height of the plot in inches
par(mar = c(5, 5, 1.5, .1))
par(mfrow=c(1,1))
plot(0:16,qstep1110000-qstep0000000,type="l",ylab="7-step general effect(texts)",xlab="days",bty="n",cex.axis=2.5,cex.lab=2.5,ylim=c(-4,0.5))
polygon(x = c(-0.1,6,6,-0.1),
y = c(-4,-4,0.5,0.5),
col = "lightgrey",border ="NA")
points(0:16,qstep1110000-qstep0000000,type="l")
text(2.9,0.2,"1-week of intervention",cex=2)
points(0:16,qstep1110000-qstep0000000,pch=15,cex=2)
points(0:16,qstep0101010-qstep0000000,type="l",pch=17,lty=2, col="brown",cex=2)
points(0:16,qstep0101010-qstep0000000,pch=16,lty=3, col="brown",cex=2)
points(0:16,qstep1001001-qstep0000000,type="l",pch=15,lty=4,col="blue",cex=2)
points(0:16,qstep1001001-qstep0000000,pch=17,lty=2,col="blue",cex=2)
abline(v=6,lty=2,lwd=2,col="red")
text(0,.5,"b)",cex=2.5)
legend("bottomright",legend=c("tx=(1,1,1,0,0,0,0)","tx=(0,1,0,1,0,1,0)","tx=(1,0,0,1,0,0,1)"),
pch = c(15,16,17), lty=c(1,2,4), col=c("black","brown","blue"),
bty = "n", # remove the bounder of the legend
lwd = c(1,1,1), pt.bg = c(NA,"grey90"),cex=2.5)
dev.off()
plot(0:16,qstep1110000-qstep0000000,type="l",ylab="7-step general effect(texts)",xlab="days",bty="n",cex.axis=2.5,cex.lab=2.5,ylim=c(-4,0.5))
polygon(x = c(-0.1,6,6,-0.1),
y = c(-4,-4,0.5,0.5),
col = "lightgrey",border ="NA")
points(0:16,qstep1110000-qstep0000000,type="l")
text(2.9,0.2,"1-week of intervention",cex=2)
points(0:16,qstep1110000-qstep0000000,pch=15,cex=2)
points(0:16,qstep0101010-qstep0000000,type="l",pch=17,lty=2, col="brown",cex=2)
points(0:16,qstep0101010-qstep0000000,pch=16,lty=3, col="brown",cex=2)
points(0:16,qstep1001001-qstep0000000,type="l",pch=15,lty=4,col="blue",cex=2)
points(0:16,qstep1001001-qstep0000000,pch=17,lty=2,col="blue",cex=2)
abline(v=6,lty=2,lwd=2,col="red")
text(0,.6,"b)",cex=2.5)
pdf(file = paste(location,"optimal_tx.pdf",sep=""),
width = 10, # The width of the plot in inches
height = 6) # The height of the plot in inches
par(mar = c(5, 5, 1.5, .1))
par(mfrow=c(1,1))
plot(0:16,qstep1110000-qstep0000000,type="l",ylab="7-step general effect(texts)",xlab="days",bty="n",cex.axis=2.5,cex.lab=2.5,ylim=c(-4,0.7))
polygon(x = c(-0.1,6,6,-0.1),
y = c(-4,-4,0.5,0.5),
col = "lightgrey",border ="NA")
points(0:16,qstep1110000-qstep0000000,type="l")
text(2.9,0.2,"1-week of intervention",cex=2)
points(0:16,qstep1110000-qstep0000000,pch=15,cex=2)
points(0:16,qstep0101010-qstep0000000,type="l",pch=17,lty=2, col="brown",cex=2)
points(0:16,qstep0101010-qstep0000000,pch=16,lty=3, col="brown",cex=2)
points(0:16,qstep1001001-qstep0000000,type="l",pch=15,lty=4,col="blue",cex=2)
points(0:16,qstep1001001-qstep0000000,pch=17,lty=2,col="blue",cex=2)
abline(v=6,lty=2,lwd=2,col="red")
text(0,.7,"b)",cex=2.5)
legend("bottomright",legend=c("tx=(1,1,1,0,0,0,0)","tx=(0,1,0,1,0,1,0)","tx=(1,0,0,1,0,0,1)"),
pch = c(15,16,17), lty=c(1,2,4), col=c("black","brown","blue"),
bty = "n", # remove the bounder of the legend
lwd = c(1,1,1), pt.bg = c(NA,"grey90"),cex=2.5)
dev.off()
plot(0:16,qstep1110000-qstep0000000,type="l",ylab="7-step general effect(texts)",xlab="days",bty="n",cex.axis=2.5,cex.lab=2.5,ylim=c(-4,0.7))
polygon(x = c(-0.1,6,6,-0.1),
y = c(-4,-4,0.5,0.5),
col = "lightgrey",border ="NA")
points(0:16,qstep1110000-qstep0000000,type="l")
text(2.9,0.2,"1-week of intervention",cex=2)
points(0:16,qstep1110000-qstep0000000,pch=15,cex=2)
points(0:16,qstep0101010-qstep0000000,type="l",pch=17,lty=2, col="brown",cex=2)
points(0:16,qstep0101010-qstep0000000,pch=16,lty=3, col="brown",cex=2)
points(0:16,qstep1001001-qstep0000000,type="l",pch=15,lty=4,col="blue",cex=2)
points(0:16,qstep1001001-qstep0000000,pch=17,lty=2,col="blue",cex=2)
plot(0:16,qstep1110000-qstep0000000,type="l",ylab="7-step general effect(texts)",xlab="days",bty="n",cex.axis=2.5,cex.lab=2.5,ylim=c(-4,0.7))
polygon(x = c(-0.1,6,6,-0.1),
y = c(-4,-4,0.7,0.7),
col = "lightgrey",border ="NA")
text(2.9,0.4,"1-week of intervention",cex=2)
points(0:16,qstep1110000-qstep0000000,type="l")
points(0:16,qstep1110000-qstep0000000,pch=15,cex=2)
points(0:16,qstep0101010-qstep0000000,type="l",pch=17,lty=2, col="brown",cex=2)
points(0:16,qstep0101010-qstep0000000,pch=16,lty=3, col="brown",cex=2)
points(0:16,qstep1001001-qstep0000000,type="l",pch=15,lty=4,col="blue",cex=2)
points(0:16,qstep1001001-qstep0000000,pch=17,lty=2,col="blue",cex=2)
abline(v=6,lty=2,lwd=2,col="red")
text(0,.7,"b)",cex=2.5)
text(2.9,0.3,"1-week of intervention",cex=2)
pdf(file = paste(location,"optimal_tx.pdf",sep=""),
width = 10, # The width of the plot in inches
height = 6) # The height of the plot in inches
par(mar = c(5, 5, 1.5, .1))
par(mfrow=c(1,1))
plot(0:16,qstep1110000-qstep0000000,type="l",ylab="7-step general effect(texts)",xlab="days",bty="n",cex.axis=2.5,cex.lab=2.5,ylim=c(-4,0.7))
polygon(x = c(-0.1,6,6,-0.1),
y = c(-4,-4,0.7,0.7),
col = "lightgrey",border ="NA")
text(2.9,0.3,"1-week of intervention",cex=2)
points(0:16,qstep1110000-qstep0000000,type="l")
points(0:16,qstep1110000-qstep0000000,pch=15,cex=2)
points(0:16,qstep0101010-qstep0000000,type="l",pch=17,lty=2, col="brown",cex=2)
points(0:16,qstep0101010-qstep0000000,pch=16,lty=3, col="brown",cex=2)
points(0:16,qstep1001001-qstep0000000,type="l",pch=15,lty=4,col="blue",cex=2)
points(0:16,qstep1001001-qstep0000000,pch=17,lty=2,col="blue",cex=2)
abline(v=6,lty=2,lwd=2,col="red")
text(0,.7,"b)",cex=2.5)
legend("bottomright",legend=c("tx=(1,1,1,0,0,0,0)","tx=(0,1,0,1,0,1,0)","tx=(1,0,0,1,0,0,1)"),
pch = c(15,16,17), lty=c(1,2,4), col=c("black","brown","blue"),
bty = "n", # remove the bounder of the legend
lwd = c(1,1,1), pt.bg = c(NA,"grey90"),cex=2.5)
dev.off()
text(2.9,0.3,"1-week of intervention",cex=1.8)
pdf(file = paste(location,"optimal_tx.pdf",sep=""),
width = 10, # The width of the plot in inches
height = 6) # The height of the plot in inches
par(mar = c(5, 5, 1.5, .1))
par(mfrow=c(1,1))
plot(0:16,qstep1110000-qstep0000000,type="l",ylab="7-step general effect(texts)",xlab="days",bty="n",cex.axis=2.5,cex.lab=2.5,ylim=c(-4,0.7))
polygon(x = c(-0.1,6,6,-0.1),
y = c(-4,-4,0.7,0.7),
col = "lightgrey",border ="NA")
text(2.9,0.3,"1-week of intervention",cex=1.8)
points(0:16,qstep1110000-qstep0000000,type="l")
points(0:16,qstep1110000-qstep0000000,pch=15,cex=2)
points(0:16,qstep0101010-qstep0000000,type="l",pch=17,lty=2, col="brown",cex=2)
points(0:16,qstep0101010-qstep0000000,pch=16,lty=3, col="brown",cex=2)
points(0:16,qstep1001001-qstep0000000,type="l",pch=15,lty=4,col="blue",cex=2)
points(0:16,qstep1001001-qstep0000000,pch=17,lty=2,col="blue",cex=2)
abline(v=6,lty=2,lwd=2,col="red")
text(0,.7,"b)",cex=2.5)
legend("bottomright",legend=c("tx=(1,1,1,0,0,0,0)","tx=(0,1,0,1,0,1,0)","tx=(1,0,0,1,0,0,1)"),
pch = c(15,16,17), lty=c(1,2,4), col=c("black","brown","blue"),
bty = "n", # remove the bounder of the legend
lwd = c(1,1,1), pt.bg = c(NA,"grey90"),cex=2.5)
dev.off()
rm(list=ls())
# Date: 2023.08.10
# Updated: 2023.11.05
# Goal: fit both covariate and outcome SSM regression model -> calculate various causal estimands
# Contents: consider two candidate exposures:
#             <keycontacts_call_totaldegree> (binary) + <keycontacts_text_reciprocity_degree> (binary)
#             for each of them, fit proper SSM without any imputation (ignore case)
# Explanation: we only consider binary exposure in the paper, therefore, we transform exposure into binary
#              for the pair of <keycontacts_call_totaldegree> + <keycontacts_text_reciprocity_degree>, which both range 0~3
#                 we merge level 3 to level 2 since there are two few of them
# Plots: Figure of raw outcome/exposures/covariates
source("/Users/xiaoxuancai/Documents/GitHub/mHealth_data_processing/helper_extract_combine_data.R")
source("/Users/xiaoxuancai/Documents/GitHub/mHealth_data_processing/Summary 1_packages.R")
source("/Users/xiaoxuancai/Documents/GitHub/mHealth_data_processing/Summary 2_helper functions.R")
source("/Users/xiaoxuancai/Documents/GitHub/SSMimpute/helper_multipleimputation.R")
source("/Users/xiaoxuancai/Documents/GitHub/Causal_estimands/helper_causal estimands.R")
load("/Users/xiaoxuancai/Documents/analysis/subject_5BT65/Data/processed/combined_all_5BT65.RData")
library(xtable)
colnames(data_5BT65)
# -------------------------------------------------------------------- #
#             Organize and add variables needed for analysis           #
# -------------------------------------------------------------------- #
# change values for certain variables
TAM_phone_modified=data_5BT65$TAM_phone
TAM_phone_modified[which(TAM_phone_modified==1)]=0.9999
TAM_phone_modified[which(TAM_phone_modified==0)]=0.0001
table(data_5BT65$keycontacts_call_totaldegree) # merge level 2 to level 1 -> turn into a binary variable
table(data_5BT65$keycontacts_text_reciprocity_degree) # merge level 2&3 to level 1 -> turn into a binary variable
keycontacts_call_totaldegree_binary=data_5BT65$keycontacts_call_totaldegree;keycontacts_call_totaldegree_binary[keycontacts_call_totaldegree_binary==2]=1;table(keycontacts_call_totaldegree_binary)
keycontacts_text_reciprocity_degree_binary=data_5BT65$keycontacts_text_reciprocity_degree;keycontacts_text_reciprocity_degree_binary[keycontacts_text_reciprocity_degree_binary>1]=1;table(keycontacts_text_reciprocity_degree_binary)
keycontacts_call_totaldegree_binary=data_5BT65$keycontacts_call_totaldegree;keycontacts_call_totaldegree_binary[keycontacts_call_totaldegree_binary==2]=1;table(keycontacts_call_totaldegree_binary)
keycontacts_text_reciprocity_degree_binary=data_5BT65$keycontacts_text_reciprocity_degree;keycontacts_text_reciprocity_degree_binary[keycontacts_text_reciprocity_degree_binary>1]=1;table(keycontacts_text_reciprocity_degree_binary)
data=data.frame(Date=data_5BT65$Date,negative_total=data_5BT65$negative_total,
keycontacts_call_totaldegree_binary,
keycontacts_text_reciprocity_degree_binary,
logit_TAM_phone=log(TAM_phone_modified/(1-TAM_phone_modified)))
param=list(list(lagged_param=list(variables=colnames(data)[-1],param=rep(3,length(colnames(data)[-1])))))
data=add_variables_procedures(data,param);
data=data.frame(intercept=1,data);colnames(data)
par(mfrow=c(2,2))
par(mar = c(4, 5, 0.1, 0.5))
plot(1:708,data$negative_total,type="l",bty="n",xlab="Time (days)",ylab="Negative mood",cex.lab=1.8,cex.axis=1.4)
text(10,20.2, "a)",cex=2)
# abline(v=c(1:708)[is.na(data$negative_total)],col="grey")
plot(1:708,data$keycontacts_call_totaldegree_binary,ylim=c(0,1.1),bty="n",type="l",xlab="Time (days)",ylab="Call connectivity",cex.lab=1.8,cex.axis=1.4)
text(10,1.06, "b)",cex=2)
plot(1:708,data$keycontacts_text_reciprocity_degree_binary,ylim=c(0,1.1),bty="n",type="h",xlab="Time (days)",ylab="Text connectivity",cex.lab=1.8,cex.axis=1.4)
text(10,1.06, "c)",cex=2)
plot(1:708,data_5BT65$TAM_phone,ylim=c(0,1.1),bty="n",type="l",xlab="Time (days)",ylab="Phone mobility",cex.lab=1.8,cex.axis=1.4)
